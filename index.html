<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Team Date Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f5f7;
        --bg-alt: #fafafc;
        --card: #ffffff;
        --accent: #007aff;
        --accent-soft: rgba(0, 122, 255, 0.12);
        --accent-strong: rgba(0, 122, 255, 0.22);
        --border: #e5e5ea;
        --text: #1d1d1f;
        --text-muted: #6e6e73;
        --danger: #ff3b30;
        --shadow-1: 0 18px 40px rgba(0, 0, 0, 0.08);
        --shadow-2: 0 1px 2px rgba(0, 0, 0, 0.06);
        --focus: 0 0 0 4px rgba(0, 122, 255, 0.22);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text',
          sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .app-shell {
        width: 100%;
        max-width: 1100px;
        margin: 16px;
        background: var(--card);
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-1);
        display: flex;
        overflow: hidden;
      }

      .sidebar {
        width: 260px;
        padding: 18px 18px 18px 18px;
        border-right: 1px solid var(--border);
        background: var(--bg-alt);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-badge {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid rgba(0, 122, 255, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text);
        font-weight: 600;
        font-size: 16px;
        box-shadow: var(--shadow-2);
      }

      .app-title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .app-title-main {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .app-title-sub {
        font-size: 11px;
        color: var(--text-muted);
      }

      .panel {
        background: var(--card);
        border-radius: 14px;
        padding: 12px 12px 12px 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-2);
      }

      .panel-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .name-input-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .profile-picker {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .profile-toggle {
        border: none;
        background: transparent;
        color: var(--accent);
        font-size: 11px;
        padding: 0;
        text-align: left;
        cursor: pointer;
      }

      .profile-toggle:hover {
        text-decoration: underline;
      }

      .profiles-panel {
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #ffffff;
        padding: 6px;
        max-height: 120px;
        overflow-y: auto;
      }

      .profiles-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .profile-pill {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f2f2f7;
        padding: 3px 8px;
        font-size: 11px;
        cursor: pointer;
        transition:
          background 0.12s ease,
          transform 0.06s ease,
          box-shadow 0.06s ease;
      }

      .profile-pill:hover {
        background: #e5e5ea;
        transform: translateY(-0.5px);
        box-shadow: var(--shadow-2);
      }

      input[type='text'] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        font-size: 13px;
        outline: none;
        transition:
          border-color 0.15s ease,
          box-shadow 0.15s ease,
          background 0.15s ease,
          transform 0.08s ease;
      }

      input[type='text']:focus {
        border-color: rgba(0, 122, 255, 0.9);
        box-shadow: var(--focus);
        background: #ffffff;
        transform: translateY(-0.5px);
      }

      .hint {
        font-size: 11px;
        color: var(--text-muted);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        background: #ffffff;
        border: 1px solid var(--border);
        color: var(--text-muted);
        font-size: 11px;
      }

      .pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.16);
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-muted);
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #ffffff;
      }

      .legend-swatch {
        width: 12px;
        height: 12px;
        border-radius: 4px;
      }

      .swatch-selectable {
        background: #f2f2f7;
        border: 1px dashed rgba(60, 60, 67, 0.28);
      }

      .swatch-mine {
        background: var(--accent-soft);
        border: 1px solid rgba(0, 122, 255, 0.55);
      }

      .swatch-others {
        background: rgba(52, 199, 89, 0.12);
        border: 1px solid rgba(52, 199, 89, 0.55);
      }

      .swatch-best {
        background: rgba(255, 149, 0, 0.12);
        border: 1px solid rgba(255, 149, 0, 0.55);
      }

      .tips {
        margin-top: 8px;
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.4;
      }

      .tips strong {
        color: var(--text);
        font-weight: 600;
      }

      .main {
        flex: 1;
        padding: 18px 18px 18px 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .top-bar-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .top-title {
        font-size: 15px;
        font-weight: 600;
      }

      .top-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .tab-buttons {
        display: inline-flex;
        padding: 3px;
        border-radius: 999px;
        background: #f2f2f7;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-2);
      }

      .tab-button {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 999px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition:
          background 0.14s ease,
          color 0.14s ease,
          transform 0.06s ease;
      }

      .tab-button span {
        font-size: 11px;
        padding: 1px 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #ffffff;
      }

      .tab-button.active {
        background: #ffffff;
        color: var(--text);
        box-shadow: var(--shadow-2);
        transform: translateY(-0.5px);
      }

      .tab-button:not(.active):hover {
        background: rgba(255, 255, 255, 0.85);
        color: var(--text);
        transform: translateY(-0.2px);
      }

      .content {
        display: flex;
        flex: 1;
        gap: 12px;
        min-height: 0;
      }

      .calendar-card,
      .summary-card {
        flex: 1;
        border-radius: 14px;
        padding: 12px;
        background: var(--card);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-1);
        display: flex;
        flex-direction: column;
      }

      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .calendar-month-label {
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.03em;
      }

      .calendar-nav {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-icon {
        border: none;
        background: #ffffff;
        color: var(--text-muted);
        border-radius: 999px;
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid var(--border);
        transition:
          background 0.14s ease,
          color 0.14s ease,
          border-color 0.14s ease,
          transform 0.06s ease;
      }

      .btn-icon:hover {
        background: #f2f2f7;
        color: var(--text);
        border-color: rgba(0, 0, 0, 0.14);
        transform: translateY(-0.3px);
      }

      .btn-main {
        border-radius: 999px;
        border: none;
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.02em;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: var(--accent);
        color: white;
        box-shadow: 0 10px 22px rgba(0, 122, 255, 0.25);
        transition:
          transform 0.08s ease,
          box-shadow 0.08s ease,
          filter 0.08s ease;
      }

      .btn-main:hover {
        transform: translateY(-0.8px);
        filter: brightness(1.05);
        box-shadow: 0 12px 26px rgba(0, 122, 255, 0.32);
      }

      .btn-main:active {
        transform: translateY(0);
        box-shadow: 0 8px 16px rgba(0, 122, 255, 0.25);
      }

      .btn-main:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        box-shadow: none;
        filter: none;
      }

      .calendar-grid {
        margin-top: 4px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #ffffff;
        box-shadow: var(--shadow-2);
        overflow: hidden;
      }

      .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        border-bottom: 1px solid var(--border);
        background: #f2f2f7;
      }

      .weekday {
        padding: 6px 4px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
        text-align: center;
      }

      .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
      }

      .day-cell {
        position: relative;
        padding: 6px 4px 8px;
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        min-height: 56px;
        background: #ffffff;
        cursor: pointer;
        transition:
          background 0.12s ease,
          box-shadow 0.12s ease,
          transform 0.08s ease,
          border-color 0.12s ease;
      }

      .day-cell:nth-child(7n) {
        border-right: none;
      }

      .day-number {
        position: relative;
        z-index: 2;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .day-content {
        position: relative;
        z-index: 2;
        font-size: 10px;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }

      .dot-row {
        display: flex;
        gap: 3px;
      }

      .dot {
        width: 5px;
        height: 5px;
        border-radius: 999px;
        background: rgba(60, 60, 67, 0.28);
      }

      .dot.mine {
        background: #34c759;
        box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.22);
      }

      .dot.others {
        background: rgba(60, 60, 67, 0.38);
        opacity: 1;
      }

      .day-badge {
        font-size: 9px;
        padding: 1px 5px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-muted);
      }

      .day-cell:hover {
        background: #f2f2f7;
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      }

      .day-cell.disabled {
        cursor: default;
        background: transparent;
        opacity: 0.45;
      }

      .day-cell.disabled:hover {
        transform: none;
        box-shadow: none;
      }

      .day-cell.selected {
        background: var(--accent-soft);
        box-shadow: var(--focus);
        border-color: rgba(0, 122, 255, 0.6);
      }

      .day-cell.selected .day-number {
        color: var(--text);
      }

      .day-cell.has-others:not(.selected) {
        background: rgba(52, 199, 89, 0.12);
        border-color: rgba(52, 199, 89, 0.55);
      }

      .day-cell.best-day {
        box-shadow:
          0 0 0 2px rgba(255, 149, 0, 0.35),
          0 8px 18px rgba(255, 149, 0, 0.18);
        position: relative;
      }

      .day-cell.best-day::after {
        content: 'BEST';
        position: absolute;
        top: 6px;
        right: 6px;
        font-size: 9px;
        padding: 1px 5px;
        border-radius: 999px;
        background: rgba(255, 149, 0, 0.95);
        color: #ffffff;
        font-weight: 600;
        letter-spacing: 0.12em;
      }

      .calendar-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        gap: 8px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .calendar-footer-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 8px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #34c759;
        box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.22);
      }

      .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 12px;
      }

      .summary-list {
        margin-top: 6px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #ffffff;
        max-height: 330px;
        overflow: auto;
      }

      .summary-row {
        display: grid;
        grid-template-columns: 0.9fr 0.35fr 1.75fr;
        gap: 8px;
        padding: 7px 10px;
        font-size: 11px;
        align-items: center;
        border-bottom: 1px solid var(--border);
      }

      .summary-row:last-child {
        border-bottom: none;
      }

      .summary-row.best {
        background: rgba(255, 149, 0, 0.08);
        box-shadow: inset 0 0 0 1px rgba(255, 149, 0, 0.18);
      }

      .summary-date {
        font-weight: 500;
      }

      .summary-count {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        justify-content: flex-start;
      }

      .summary-count-pill {
        padding: 3px 7px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--border);
      }

      .summary-count-pill.strong {
        background: rgba(52, 199, 89, 0.12);
        border-color: rgba(52, 199, 89, 0.55);
      }

      .summary-users {
        color: var(--text-muted);
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .summary-empty {
        padding: 12px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .error {
        color: var(--danger);
        font-size: 11px;
        margin-top: 6px;
      }

      .success {
        color: #34c759;
        font-size: 11px;
        margin-top: 6px;
      }

      @media (max-width: 960px) {
        .app-shell {
          flex-direction: column;
          max-width: 100%;
        }

        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid var(--border);
          flex-direction: row;
          align-items: flex-start;
          justify-content: space-between;
        }

        .sidebar > .panel {
          flex: 1;
        }

        .content {
          flex-direction: column;
        }

        .calendar-card,
        .summary-card {
          max-height: none;
        }

        .summary-list {
          max-height: 240px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo-badge">üç∏</div>
          <div class="app-title">
            <div class="app-title-main">Team Date Planner</div>
            <div class="app-title-sub">Pick the best night for drinks &amp; dinner</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Your profile</div>
          <div class="name-input-row">
            <label for="name-input" class="hint"
              >Enter the name your teammates will recognise.</label
            >
            <input
              id="name-input"
              type="text"
              placeholder="e.g. Alex, Sam, Maria‚Ä¶"
              autocomplete="off"
            />
            <div class="hint">
              This stays
              <strong>on your computer only</strong>
              and is used to track your choices.
            </div>
          </div>
          <div class="profile-picker">
            <button id="toggle-profiles" class="profile-toggle">
              Or pick your name from the list
            </button>
            <div id="profiles-panel" class="profiles-panel" style="display: none">
              <div class="hint" style="margin-bottom: 4px">
                Click your name to reuse your previous choices.
              </div>
              <div id="profiles-list" class="profiles-list"></div>
            </div>
          </div>
          <div id="name-error" class="error" style="display: none"></div>
        </div>

        <div class="panel">
          <div class="panel-title">How it works</div>
          <div class="pill">
            <div class="pill-dot"></div>
            Everyone uses the
            <strong>same folder</strong>
            to share one calendar.
          </div>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-swatch swatch-selectable"></span>
              Click to toggle availability
            </div>
            <div class="legend-item">
              <span class="legend-swatch swatch-mine"></span>
              Your available dates
            </div>
            <div class="legend-item">
              <span class="legend-swatch swatch-others"></span>
              Others available
            </div>
            <div class="legend-item">
              <span class="legend-swatch swatch-best"></span>
              Best date so far
            </div>
          </div>
          <div class="tips">
            - Put this folder in a
            <strong>shared drive</strong>
            (Teams/Dropbox/Drive‚Ä¶).
            <br />
            - Everyone runs the app from the
            <strong>same shared folder</strong>
            so all availability is merged.
          </div>
        </div>
      </aside>

      <main class="main">
        <div class="top-bar">
          <div class="top-bar-left">
            <div class="top-title">Choose when you‚Äôre free</div>
            <div class="top-subtitle">
              Click all dates that work for you. We‚Äôll highlight the dates with the
              most people.
            </div>
          </div>
          <div class="tab-buttons">
            <button class="tab-button active" data-tab="calendar">
              Calendar
              <span id="tab-calendar-count">You</span>
            </button>
            <button class="tab-button" data-tab="summary">
              Best dates
              <span id="tab-summary-count">0</span>
            </button>
          </div>
        </div>

        <div class="content">
          <section class="calendar-card" data-tab-content="calendar">
            <div class="calendar-header">
              <div class="calendar-month-label" id="month-label"></div>
              <div class="calendar-nav">
                <button class="btn-icon" id="prev-month" title="Previous month">
                  ‚óÄ
                </button>
                <button class="btn-icon" id="today-month" title="Jump to current month">
                  ‚óè
                </button>
                <button class="btn-icon" id="next-month" title="Next month">
                  ‚ñ∂
                </button>
              </div>
            </div>

            <div class="calendar-grid">
              <div class="calendar-weekdays">
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
                <div class="weekday">Sun</div>
              </div>
              <div class="calendar-days" id="calendar-days"></div>
            </div>

            <div class="calendar-footer">
              <div class="calendar-footer-left">
                <div class="status-chip">
                  <div class="status-dot"></div>
                  <span id="status-label">Not saved yet</span>
                </div>
                <div>
                  <span id="selection-count">0 dates selected</span>
                  <span> ¬∑ </span>
                  <span id="others-count">0 teammates already picked dates</span>
                </div>
              </div>
              <button class="btn-main" id="save-btn">
                Save my availability
              </button>
            </div>
          </section>

          <section
            class="summary-card"
            data-tab-content="summary"
            style="display: none"
          >
            <div class="summary-header">
              <div>
                <div style="font-size: 13px; font-weight: 600">Best dates to meet</div>
                <div style="font-size: 11px; color: var(--text-muted)">
                  Sorted by number of people available, then by date.
                </div>
              </div>
            </div>
            <div class="summary-list" id="summary-list"></div>
          </section>
        </div>
      </main>
    </div>

    <script>
      const api = window.availabilityAPI;

      const nameInput = document.getElementById('name-input');
      const nameError = document.getElementById('name-error');
      const monthLabel = document.getElementById('month-label');
      const calendarDays = document.getElementById('calendar-days');
      const saveBtn = document.getElementById('save-btn');
      const statusLabel = document.getElementById('status-label');
      const selectionCount = document.getElementById('selection-count');
      const othersCount = document.getElementById('others-count');
      const summaryList = document.getElementById('summary-list');
      const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
      const tabCalendarCount = document.getElementById('tab-calendar-count');
      const tabSummaryCount = document.getElementById('tab-summary-count');
      const toggleProfilesBtn = document.getElementById('toggle-profiles');
      const profilesPanel = document.getElementById('profiles-panel');
      const profilesList = document.getElementById('profiles-list');

      let currentMonth = new Date();
      currentMonth.setDate(1);

      let mySelectedDates = new Set();
      let allSummary = [];
      let myName = '';
      let knownProfiles = [];

      function formatISODate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      function formatPrettyDate(iso) {
        const [year, month, day] = iso.split('-').map((x) => parseInt(x, 10));
        const d = new Date(year, month - 1, day);
        return d.toLocaleDateString(undefined, {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
        });
      }

      function updateSelectionCount() {
        const count = mySelectedDates.size;
        selectionCount.textContent =
          count === 1 ? '1 date selected' : count + ' dates selected';
        tabCalendarCount.textContent = myName ? myName : 'You';
      }

      function updateOthersCount() {
        const uniqueUsers = new Set();
        allSummary.forEach((item) => {
          item.users.forEach((u) => {
            if (u) uniqueUsers.add(u);
          });
        });
        if (myName) uniqueUsers.delete(myName);
        const count = uniqueUsers.size;
        othersCount.textContent =
          count === 1
            ? '1 teammate already picked dates'
            : count + ' teammates already picked dates';
      }

      function renderCalendar() {
        monthLabel.textContent = currentMonth.toLocaleDateString(undefined, {
          month: 'long',
          year: 'numeric',
        });

        calendarDays.innerHTML = '';

        const firstDay = new Date(currentMonth);
        const startWeekday = (firstDay.getDay() + 6) % 7;

        const daysInMonth = new Date(
          currentMonth.getFullYear(),
          currentMonth.getMonth() + 1,
          0
        ).getDate();

        for (let i = 0; i < startWeekday; i++) {
          const placeholder = document.createElement('div');
          placeholder.className = 'day-cell disabled';
          calendarDays.appendChild(placeholder);
        }

        const bestCount = allSummary.length > 0 ? allSummary[0].count : 0;
        const bestDates = new Set(
          allSummary.filter((s) => s.count === bestCount).map((s) => s.date)
        );

        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(
            currentMonth.getFullYear(),
            currentMonth.getMonth(),
            day
          );
          const iso = formatISODate(dateObj);

          const cell = document.createElement('div');
          cell.className = 'day-cell';
          cell.dataset.date = iso;

          const mySelected = mySelectedDates.has(iso);
          const summaryItem = allSummary.find((s) => s.date === iso);
          const count = summaryItem ? summaryItem.count : 0;
          const isBest = bestDates.has(iso) && count > 0;

          if (summaryItem && summaryItem.users.some((u) => u !== myName)) {
            cell.classList.add('has-others');
          }
          if (mySelected) {
            cell.classList.add('selected');
          }
          if (isBest) {
            cell.classList.add('best-day');
          }

          const dayNumber = document.createElement('div');
          dayNumber.className = 'day-number';
          dayNumber.textContent = day;

          const content = document.createElement('div');
          content.className = 'day-content';

          const dots = document.createElement('div');
          dots.className = 'dot-row';

          const myDot = document.createElement('div');
          myDot.className = 'dot';
          if (mySelected) myDot.classList.add('mine');
          dots.appendChild(myDot);

          if (count > (mySelected ? 1 : 0)) {
            const othersDot = document.createElement('div');
            othersDot.className = 'dot others';
            dots.appendChild(othersDot);
          }

          const badge = document.createElement('div');
          badge.className = 'day-badge';
          badge.textContent = count === 0 ? '‚Äì' : count + ' going';

          content.appendChild(dots);
          content.appendChild(badge);

          cell.appendChild(dayNumber);
          cell.appendChild(content);

          cell.addEventListener('click', () => {
            if (!myName) {
              nameError.style.display = 'block';
              nameError.textContent = 'Please enter your name before selecting dates.';
              nameInput.focus();
              return;
            }

            if (mySelectedDates.has(iso)) {
              mySelectedDates.delete(iso);
            } else {
              mySelectedDates.add(iso);
            }
            statusLabel.textContent = 'Not saved yet';
            renderCalendar();
            updateSelectionCount();
          });

          calendarDays.appendChild(cell);
        }
      }

      function renderSummary() {
        summaryList.innerHTML = '';

        if (!allSummary.length) {
          summaryList.innerHTML =
            '<div class="summary-empty">No availability saved yet. Ask your teammates to open the app and save their dates here.</div>';
          tabSummaryCount.textContent = '0';
          return;
        }

        const bestCount = allSummary[0].count;
        tabSummaryCount.textContent = String(allSummary.length);

        allSummary.forEach((item) => {
          const row = document.createElement('div');
          row.className = 'summary-row';
          if (item.count === bestCount && item.count > 0) {
            row.classList.add('best');
          }

          const dateEl = document.createElement('div');
          dateEl.className = 'summary-date';
          dateEl.textContent = formatPrettyDate(item.date);

          const countEl = document.createElement('div');
          countEl.className = 'summary-count';

          const pill = document.createElement('div');
          pill.className = 'summary-count-pill';
          if (item.count >= 3) pill.classList.add('strong');
          pill.textContent =
            item.count === 1 ? '1 person' : item.count + ' people';

          countEl.appendChild(pill);

          const usersEl = document.createElement('div');
          usersEl.className = 'summary-users';
          usersEl.textContent = item.users.join(', ');

          row.appendChild(dateEl);
          row.appendChild(countEl);
          row.appendChild(usersEl);

          summaryList.appendChild(row);
        });
      }

      function renderProfiles() {
        profilesList.innerHTML = '';
        if (!knownProfiles.length) {
          profilesList.innerHTML =
            '<div class="hint">No saved profiles yet. Once teammates save their availability, their names will appear here.</div>';
          return;
        }

        knownProfiles.forEach((name) => {
          const pill = document.createElement('button');
          pill.type = 'button';
          pill.className = 'profile-pill';
          pill.textContent = name;
          pill.addEventListener('click', async () => {
            myName = name;
            nameInput.value = name;
            tabCalendarCount.textContent = name;
            localStorage.setItem('team-date-planner:name', name);
            nameError.style.display = 'none';
            await loadDataForName();
            profilesPanel.style.display = 'none';
          });
          profilesList.appendChild(pill);
        });
      }

      async function loadProfiles() {
        try {
          const users = await api.getAllUsers();
          knownProfiles = users || [];
          renderProfiles();
        } catch (err) {
          console.error(err);
        }
      }

      async function loadDataForName() {
        if (!myName) return;
        try {
          const [myDates, summary] = await Promise.all([
            api.getUserAvailability(myName),
            api.getSummary(),
          ]);
          mySelectedDates = new Set(myDates || []);
          allSummary = summary || [];
          statusLabel.textContent = 'Loaded from shared calendar';
          updateSelectionCount();
          updateOthersCount();
          renderCalendar();
          renderSummary();
        } catch (err) {
          console.error(err);
          statusLabel.textContent = 'Could not load data (check file access).';
        }
      }

      async function saveAvailability() {
        if (!myName) {
          nameError.style.display = 'block';
          nameError.textContent = 'Please enter your name before saving.';
          nameInput.focus();
          return;
        }
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving‚Ä¶';
        nameError.style.display = 'none';
        try {
          await api.saveUserAvailability(myName, Array.from(mySelectedDates));
          const summary = await api.getSummary();
          allSummary = summary || [];
          statusLabel.textContent = 'Saved to shared calendar ‚úì';
          renderCalendar();
          renderSummary();
          updateOthersCount();
          await loadProfiles();
        } catch (err) {
          console.error(err);
          statusLabel.textContent = 'Error while saving. Check folder permissions.';
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save my availability';
        }
      }

      function handleTabClick(tab) {
        tabButtons.forEach((btn) => {
          const isActive = btn.dataset.tab === tab;
          btn.classList.toggle('active', isActive);
        });

        document
          .querySelectorAll('[data-tab-content]')
          .forEach((section) => {
            const show = section.getAttribute('data-tab-content') === tab;
            section.style.display = show ? '' : 'none';
          });
      }

      function initName() {
        const stored = localStorage.getItem('team-date-planner:name');
        if (stored) {
          myName = stored;
          nameInput.value = myName;
          tabCalendarCount.textContent = myName;
        }

        nameInput.addEventListener('input', () => {
          const value = nameInput.value.trim();
          myName = value;
          if (!value) {
            tabCalendarCount.textContent = 'You';
          } else {
            tabCalendarCount.textContent = value;
            localStorage.setItem('team-date-planner:name', value);
          }
          nameError.style.display = 'none';
        });
      }

      toggleProfilesBtn.addEventListener('click', () => {
        const isOpen = profilesPanel.style.display !== 'none';
        profilesPanel.style.display = isOpen ? 'none' : 'block';
      });

      document.getElementById('prev-month').addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        renderCalendar();
      });
      document.getElementById('next-month').addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        renderCalendar();
      });
      document.getElementById('today-month').addEventListener('click', () => {
        currentMonth = new Date();
        currentMonth.setDate(1);
        renderCalendar();
      });

      saveBtn.addEventListener('click', saveAvailability);

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          handleTabClick(btn.dataset.tab);
        });
      });

      (async function bootstrap() {
        initName();
        renderCalendar();
        if (myName) {
          await loadDataForName();
        } else {
          try {
            const summary = await api.getSummary();
            allSummary = summary || [];
            updateOthersCount();
            renderCalendar();
            renderSummary();
          } catch (err) {
            console.error(err);
          }
        }
        await loadProfiles();
      })();
    </script>
  </body>
</html>


